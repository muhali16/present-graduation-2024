<%- include('partials/header') %>
<main class="flex flex-col justify-center p-6 gap-5 mx-auto">
  <h1 class="text-3xl font-bold text-center">Siswa Peserta Lepas Kenang 2024</h1>
  <button id="exportButton" class="border-2 mx-auto p-2 border-white bg-green-500 text-white rounded-md font-semibold text-sm">Export to Excel</button>
  <table id="studentTable" class="display">
    <thead>
      <tr class="border-2">
        <th>No</th>
        <th>Nama</th>
        <th>Nis</th>
        <th>Departemen</th>
        <th>Hadir</th>
      </tr>
    </thead>
    <tbody>
      <% let i = 1; students.forEach(student => { %>
        <tr class="border-b-2">
          <td class="text-center p-2"><%= i %></td>
          <td class="p-2">
            <a
              href="/students/<%= student.nis ?? "#" %>"
              class="text-blue-900 hover:text-blue-500"
              ><%= student.nama ?? "Undefined" %></a
            >
          </td>
          <td class="text-center p-2"><%= student.nis %></td>
          <td class="text-center p-2"><%= student.departemen %></td>
          <td class="text-center p-2"><%= student.hadir == 1 ? "✅" : "❌" %></td>
        </tr>
        <% i++ }); %>
    </tbody>
  </table>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
  <script src="https://cdn.datatables.net/2.0.7/js/dataTables.js"></script>
  <script>
    $(document).ready(function() {
        var table = $('#studentTable').DataTable();

        $('#exportButton').on('click', function() {
            exportTableToExcel(table, 'Data Kehadiran Lepas Kenang 2024');
        });
    });

    function exportTableToExcel(table, filename = '') {
        var data = [];
        var headers = [];

        // Get headers
        table.columns().header().each(function(header) {
            headers.push($(header).text());
        });

        // Get data
        table.rows().every(function() {
            var row = [];
            $(this.node()).find('td').each(function() {
                // If the cell contains a link, get the text inside the link
                var cellContent = $(this).find('a').length ? $(this).find('a').text() : $(this).text();
                row.push(cellContent);
            });
            data.push(row);
        });

        // Create a workbook and add the data
        var wb = XLSX.utils.book_new();
        var ws_data = [headers].concat(data); // Combine headers and data
        var ws = XLSX.utils.aoa_to_sheet(ws_data); // Convert array of arrays to sheet

        XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
        
        var wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });
        
        var s2ab = function(s) { 
            var buf = new ArrayBuffer(s.length); 
            var view = new Uint8Array(buf); 
            for (var i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF; 
            return buf; 
        };

        var blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
        var link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        link.download = filename ? filename + '.xlsx' : 'excel_data.xlsx';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
  </script>
</main>
<%- include('partials/footer') %>
