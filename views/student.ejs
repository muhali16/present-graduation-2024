<%- include('partials/header') %>
<main class="flex flex-col justify-center p-6 gap-5 mx-auto">
  <h1 class="text-3xl font-bold text-center">Siswa Peserta Lepas Kenang 2024</h1>
  <button id="exportButton" class="border-2 mx-auto p-2 border-white bg-green-500 text-white rounded-md font-semibold text-sm">Export to Excel</button>
  <div class="overflow-auto">
    <table id="studentTable" class="display">
      <thead>
        <tr class="border-2">
          <th  data-priority="1">No</th>
          <th  data-priority="1">Nama</th>
          <th>NIS</th>
          <th>Departemen</th>
          <th>Unit Sekolah</th>
          <th>Nama Ortu</th>
          <th>Telp Ortu</th>
          <th  data-priority="1">Hadir</th>
        </tr>
      </thead>
      <tbody>
        <% let i = 1; students.forEach(student => { %>
          <tr class="border-b-2">
            <td class="text-center p-2"><%= i %></td>
            <td class="p-2">
              <a
                href="/students/<%= student.nis ?? "#" %>"
                class="text-blue-900 hover:text-blue-500"
                ><%= student.nama ?? "Undefined" %></a
              >
            </td>
            <td class="text-center p-2"><%= student.nis %></td>
            <td class="text-center p-2"><%= student.departemen %></td>
            <td class="p-2"><%= student.unit_sekolah %></td>
            <td class="p-2"><%= '' %></td>
            <td class="p-2"><%= '' %></td>
            <td class="text-center p-2"><%= student.hadir == 1 ? "✅" : "❌" %></td>
          </tr>
          <% i++ }); %>
      </tbody>
    </table>
    
  </div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
  <script src="https://cdn.datatables.net/2.0.7/js/dataTables.js"></script>
  <script src="https://cdn.datatables.net/responsive/3.0.2/js/dataTables.responsive.js"></script>
  <script src="https://cdn.datatables.net/responsive/3.0.2/js/responsive.dataTables.js"></script>
  <script>
    $(document).ready(function() {
        const table = $('#studentTable').DataTable(
          {
            responsive: true,
            columnDefs: [
                { responsivePriority: 1, targets: 0 },
            ]
          }
        );

        $('#exportButton').on('click', function() {
            exportTableToExcel(table, 'Data Kehadiran Lepas Kenang 2024');
        });
    });

    function exportTableToExcel(table, filename = '') {
        const data = [];
        const headers = [];

        // Get headers
        table.columns().header().each(function(header) {
            headers.push($(header).text());
        });

        // Get data
        table.rows().every(function() {
            const row = [];
            $(this.node()).find('td').each(function() {
                // If the cell contains a link, get the text inside the link
                const cellContent = $(this).find('a').length ? $(this).find('a').text() : $(this).text();
                row.push(cellContent);
            });
            data.push(row);
        });

        // Create a workbook and add the data
        const wb = XLSX.utils.book_new();
        const ws_data = [headers].concat(data); // Combine headers and data
        const ws = XLSX.utils.aoa_to_sheet(ws_data); // Convert array of arrays to sheet

        XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
        
        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });
        
        const s2ab = function(s) { 
            const buf = new ArrayBuffer(s.length); 
            const view = new Uint8Array(buf); 
            for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF; 
            return buf; 
        };

        const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        link.download = filename ? filename + '.xlsx' : 'excel_data.xlsx';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
  </script>
</main>
<%- include('partials/footer') %>
